<?php ob_start();session_start();include(dirname(dirname(__FILE__)).'/header.php');include(dirname(dirname(__FILE__)).'/objects/class_connection.php');require_once '../objects/class_users.php';include(dirname(dirname(__FILE__)).'/objects/class_setting.php');include(dirname(dirname(__FILE__)).'/objects/class_booking.php');;include(dirname(dirname(__FILE__)).'/objects/class_services.php');require_once '../assets/lib/Sinfini_sms.php';$con = new cleanto_db();$conn = $con->connect();$user = new cleanto_users();$user->conn = $conn;date_default_timezone_set("Asia/Kolkata");if($_POST['part']=="mobile"){	$mobile = "+91".$_POST['mobile'];	$created_at = date('Y-m-d H:i:s');	$query = mysqli_query($conn,"SELECT * FROM ct_users WHERE phone ='{$mobile}'");	$ctime = date('Y-m-d H:i:s');	$extime=date("Y-m-d H:i:s", strtotime("+30 minutes"));	/*$q = "SELECT * FROM ct_user_reg_otp WHERE mobile_num ={$mobile} AND created_at<='{$ctime}' AND created_at>DATE_SUB('$ctime', INTERVAL 30 MINUTE)";	$e = mysqli_query($conn, $q);*/	if(mysqli_num_rows($query)>0){		echo "A";	}else{		$_SESSION['mobile_number'] = $mobile;		$otp = $user->generate_otp(4);		$message = "Yup-Serve : Your OTP verification code is {$otp}";		$sms_api = new Sinfini_sms();	    // send SMS using API	    	    // get 15 MInutes time interval	    $extime=date("Y-m-d H:i:s", strtotime("+15 minutes"));	    $sms_api->send($mobile, $message);	    $query3 = mysqli_query($conn,"SELECT * FROM ct_user_reg_otp WHERE mobile_num ='{$mobile}'");	    if(mysqli_num_rows($query3)>0){	    	$query = "UPDATE ct_user_reg_otp SET otp = '{$otp}',created_at='{$created_at}',expired_at='{$extime}' WHERE mobile_num = '{$mobile}'";	    	$query2 = mysqli_query($conn, $query);	    	$otpData = mysqli_fetch_object($query3);	    	$_SESSION['temp_user_id'] = $temp_id =  $otpData->id;	    	echo "S";	    }else{	    	$query = "INSERT into ct_user_reg_otp (`mobile_num`,`otp`, `verify_status`, `created_at`, `expired_at`) values('{$mobile}','{$otp}',0,'{$created_at}','{$extime}')";		    //echo $query;		    $query2 = mysqli_query($conn, $query);		    $last_id = mysqli_insert_id($conn);		    $_SESSION['temp_user_id'] = $last_id;		    echo "S";	    }	}}if($_POST['part']=="resend"){	$mobile = "+91".$_POST['mobile'];	$temp_user_id = $_SESSION['temp_user_id'];	$ctime = date('Y-m-d H:i:s');	$extime=date("Y-m-d H:i:s", strtotime("+30 minutes"));	/*$q = "SELECT * FROM ct_user_reg_otp WHERE mobile_num ='{$mobile}' AND created_at<='{$ctime}' AND created_at>DATE_SUB('$ctime', INTERVAL 30 MINUTE)";	$e = mysqli_query($conn, $q);	mysqli_num_rows($e);*/	$q1 = "SELECT * FROM ct_user_reg_otp WHERE id ={$temp_user_id} AND expired_at<='{$extime}' ORDER BY id DESC LIMIT 1";		$query = mysqli_query($conn, $q1);		if(mysqli_num_rows($query)>0){			$data = mysqli_fetch_object($query);			$mobile = $data->mobile_num;			# - Sending otp			$otp = $user->generate_otp(4);			$message = "Yup-Serve : Your OTP verification code is {$otp}";			$sms_api = new Sinfini_sms();		    		    $sms_api->send($mobile, $message);		    // send SMS using API		    $created_at = date('Y-m-d H:i:s');		    // get 15 MInutes time interval		    $extime=date("Y-m-d H:i:s", strtotime("+15 minutes"));		    # - Storing data		$query2 = mysqli_query($conn,"SELECT * FROM ct_user_reg_otp WHERE mobile_num ='{$mobile}'");	    if(mysqli_num_rows($query2)>0){	    	$query = "UPDATE ct_user_reg_otp SET otp = '{$otp}',created_at='{$created_at}',expired_at='{$extime}' WHERE mobile_num = '{$mobile}'";	    	$query2 = mysqli_query($conn, $query);	    	$otpData = mysqli_fetch_object($query2);	    	$_SESSION['temp_user_id'] = $temp_id =  $otpData->id;	    	echo "S";	    }else{	    	$query = "INSERT into ct_user_reg_otp (`mobile_num`,`otp`, `verify_status`, `created_at`, `expired_at`) values('{$mobile}','{$otp}',0,'{$created_at}','{$extime}')";		    //echo $query;		    $query2 = mysqli_query($conn, $query);		    $last_id = mysqli_insert_id($conn);		    $_SESSION['temp_user_id'] = $last_id;		    echo "S";	    }		   /* $query = "INSERT into ct_user_reg_otp (`mobile_num`,`otp`, `verify_status`, `created_at`, `expired_at`) values('{$mobile}','{$otp}',0,'{$created_at}','{$extime}')";		    //echo $query;		    $query2 = mysqli_query($conn, $query);		    $last_id = mysqli_insert_id($conn);		    $_SESSION['temp_user_id'] = $last_id;			echo "S";*/		}else{			echo "I";		}}if($_POST['part']=="otp"){	$otp = $_POST['mobile'];	$temp_user_id = $_SESSION['temp_user_id'];	$mobile_number = $_SESSION['mobile_number'];	$xtime = date("Y-m-d H:i:s", time());;	$q1 = "SELECT * FROM ct_user_reg_otp WHERE mobile_num ='{$mobile_number}' and otp = '{$otp}' and expired_at >= '{$xtime}'";	$query = mysqli_query($conn, $q1);	if(mysqli_num_rows($query)>0){		mysqli_query($conn,"UPDATE ct_user_reg_otp set verify_status=1 WHERE id ={$temp_user_id}");		echo "S";	}else{		echo "I";	}} ?>