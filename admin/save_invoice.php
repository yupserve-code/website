<?phpinclude(dirname(__FILE__) . '/header.php');include(dirname(__FILE__) . '/user_session_check.php');require_once '../assets/lib/Firebase.php';$setting = new cleanto_setting();$setting->conn = $conn;$gettimeformat = $setting->get_option('ct_time_format'); /* CHECK FOR VC AND PARKING STATUS */$global_vc_status = $setting->get_option('ct_vc_status');$global_p_status = $setting->get_option('ct_p_status'); /* CHECK FOR VC AND PARKING STATUS END */?><?phpif ($_SERVER['REQUEST_METHOD'] == "POST") {    if (!empty($_POST['order_id']) && !empty($_POST['service_id']) && !empty($_POST['sub_service_id']) &&            !empty($_POST['addon_item_desc']) && !empty($_POST['addon_item_code']) &&            !empty($_POST['addon_price']) && !empty($_POST['addon_qty']) &&            !empty($_POST['addon_discount']) && !empty($_POST['addon_tax_type']) &&            !empty($_POST['addon_total'])) {        $order_id = (int) trim($_POST['order_id']);        date_default_timezone_set('Asia/Kolkata');        $current_time = date('Y-m-d H:i:s', time());        $sql_chk = "SELECT * FROM ct_invoice WHERE order_id='{$order_id}'";        $res_chk = mysqli_query($conn, $sql_chk);        if (mysqli_num_rows($res_chk) > 0) {            header('Location: view_invoice.php?order_id=' . $order_id);            exit;        } else {            $invoice_no = "YPSRV{$order_id}";                        $sql_cpn = "SELECT * FROM ct_default_coupon WHERE id='1'";            $res_cpn = mysqli_query($conn, $sql_cpn);            $dflt_cpn = mysqli_fetch_object($res_cpn);                        // INSERT into invoice table            $sql_ins = "INSERT INTO ct_invoice (order_id, invoice_no, created_at)                     VALUES ('{$order_id}', '{$invoice_no}', '{$current_time}')";            mysqli_query($conn, $sql_ins);            $invoice_id = mysqli_insert_id($conn);            foreach ((array) $_POST['addon_item_desc'] as $key => $val) {                $service_id = (int) trim($_POST['service_id'][$key]);                $sub_service_id = (int) trim($_POST['sub_service_id'][$key]);                $item_desc = trim($_POST['addon_item_desc'][$key]);                $item_code = trim($_POST['addon_item_code'][$key]);                $rate = trim($_POST['addon_price'][$key]);                $qty = trim($_POST['addon_qty'][$key]);                $discount = trim($_POST['addon_discount'][$key]);                $tax_type_id = trim($_POST['addon_tax_type'][$key]);                $amount = trim($_POST['addon_total'][$key]);                $qty_total = ($rate * $qty);                $sql_tax = "SELECT percent FROM ct_gst_percent WHERE id='{$tax_type_id}'";                $res_tax = mysqli_query($conn, $sql_tax);                $row_tax = mysqli_fetch_object($res_tax);                $discount_amount = ($qty_total * $discount) / 100;                $tax_amount = ((($rate * $qty) - $discount_amount) * $row_tax->percent / 100);                                //echo $tax_amount;exit;                // INSERT into proforma_invoice table                $sql_ins_pi = "INSERT INTO ct_proforma_invoice (order_id, invoice_id, service_id, sub_service_id, item_desc, item_code, rate, qty, discount, tax_type_id, tax_amount, amount, created_date) VALUES ('{$order_id}', '{$invoice_id}', '{$service_id}', '{$sub_service_id}', '{$item_desc}', '{$item_code}', '{$rate}', '{$qty}','{$discount_amount}', '{$tax_type_id}', '{$tax_amount}', '{$amount}', '{$current_time}')";                mysqli_query($conn, $sql_ins_pi);            }                        // SELECT the total final amount from Order ID             $sql_amnt = "SELECT SUM(amount) AS final_amnt FROM ct_proforma_invoice WHERE order_id='{$order_id}'";            $res_amnt = mysqli_query($conn, $sql_amnt);            $amnt_dtls = mysqli_fetch_object($res_amnt);                        $final_discount_amount = ($amnt_dtls->final_amnt * $dflt_cpn->value) / 100;                        // UDPATE deafult coupon amount to invoice            $sql_cpn_upd = "UPDATE ct_invoice SET default_discount='{$dflt_cpn->value}', default_discount_amount='{$final_discount_amount}' WHERE order_id='{$order_id}'";            mysqli_query($conn, $sql_cpn_upd);            $sql_sel = "SELECT * FROM ct_bookings WHERE order_id='{$order_id}'";            $res_sel = mysqli_query($conn, $sql_sel);            // order data            $order_data = mysqli_fetch_object($res_sel);            /*             * INSERT into booking status history table             */            $stat_msg = "Invoice generated for order #{$order_id}";            $sql_ins_stat = "INSERT INTO ct_booking_task_history (order_id, staff_id, customer_id, status, created_at) VALUES ('{$order_id}', '{$order_data->staff_ids}', '{$order_data->client_id}', '{$stat_msg}', '{$current_time}')";            mysqli_query($conn, $sql_ins_stat);            // send push notifications to the customer and staff            $firebase = new Firebase();            $firebase->set_api('AIzaSyDfRQ1UO-peN9EI2_QRe_MOZX67-XI9pz8');            /*             *  Send Notification to the customer             */            // Get the customer Device Token            $sql_token = "SELECT token FROM ct_customer_device_token WHERE customer_id='{$order_data->client_id}'";            $res_token = mysqli_query($conn, $sql_token);            if (mysqli_num_rows($res_token)) {                $row_token = mysqli_fetch_object($res_token);            }            // data array to be sent to firebase server            $cstmr_data = array(                'title' => 'Yupserve',                'request_id' => $order_id,                'message' => $stat_msg,                'action' => 'booking',            );            $notifcst_array = array(                'title' => 'Yupserve',                'body' => $stat_msg,                'sound' => 'default',                'click_action' => 'FCM_PLUGIN_ACTIVITY',                'icon' => "fcm_push_icon"            );            $firebase->send_to_single($row_token->token, $cstmr_data, $notifcst_array);            // INSERT into customer notification table            $sql_cstm_notif = "INSERT INTO ct_user_notification (user_id, order_id, text, is_read, created_at) VALUES('{$order_data->client_id}', '{$order_id}', '{$stat_msg}', '0', '{$current_time}')";            mysqli_query($conn, $sql_cstm_notif);            /*             *  Send Notification to the staff             */            // Get the staff Device Token            $sql_staff_token = "SELECT token FROM ct_staff_device_token WHERE staff_id='{$order_data->staff_ids}'";            $res_staff_token = mysqli_query($conn, $sql_staff_token);            if (mysqli_num_rows($res_staff_token)) {                $row_staff_token = mysqli_fetch_object($res_staff_token);            }            // data array to be sent to firebase server            $staff_data = array(                'title' => 'Yupserve',                'request_id' => $order_id,                'message' => $stat_msg,                'action' => 'booking',            );            $notif_array = array(                'title' => 'Yupserve',                'body' => $stat_msg,                'sound' => 'default',                'click_action' => 'FCM_PLUGIN_ACTIVITY',                'icon' => "fcm_push_icon"            );            $firebase->send_to_single($row_staff_token->token, $staff_data, $notif_array);            // INSERT into customer notification table            $sql_stf_notif = "INSERT INTO ct_staff_notification (staff_id, order_id, text, is_read, created_at) VALUES('{$order_data->staff_ids}', '{$order_id}', '{$stat_msg}', '0', '{$current_time}')";            mysqli_query($conn, $sql_stf_notif);            header('Location: view_invoice.php?order_id=' . $order_id);            exit(0);        }    } else {        echo "Please fill the fields";        header('Location: invoice.php?order_id=' . $order_id);        exit(0);    }}?>