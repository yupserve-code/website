<?phpsession_start();require_once 'objects/class_connection.php';require_once 'objects/class_users.php';require_once 'objects/class_setting.php';require_once 'assets/lib/Sinfini_sms.php';$database = new cleanto_db();$conn = $database->connect();$database->conn = $conn;$user = new cleanto_users();$user->conn = $conn;$settings = new cleanto_setting();$settings->conn = $conn;if (isset($_POST['action']) && $_POST['action'] == 'get_login_data') {    $json = array();    $mobile = trim(strip_tags(mysqli_real_escape_string($conn, $_POST['mobile'])));    // check that if the mobile number exists in DB    $existing_login = $user->check_user_login_mobile($mobile);    if (mysqli_num_rows($existing_login) > 0) {        $row_user = mysqli_fetch_object($existing_login);        // userID        $user_id = $row_user->id;        $_SESSION['user_id'] = $row_user->id;        // Generate OTP        $otp = $user->generate_otp(4);        $message = "Yup-Serve : Your OTP verification code is {$otp}";        // SMS API        $sms_api = new Sinfini_sms();        // send SMS using API        $sms_api->send($mobile, $message);        // created_at        date_default_timezone_set('Asia/Kolkata');        $created_at = date('Y-m-d H:i:s', time());        // get 15 MInutes time interval        $expired_at = $user->getCurrentTime();        // check that user already exists        $otp_sql = "SELECT * FROM ct_user_otp WHERE user_id='{$user_id}'";        $result_otp = mysqli_query($conn, $otp_sql);        // check that row exists in OTP table        if (mysqli_num_rows($result_otp) > 0) {            // UPDATE OTP table            $sql_upd = "UPDATE ct_user_otp SET otp='{$otp}', created_at='{$created_at}', expired_at='{$expired_at}' WHERE user_id='{$user_id}'";            mysqli_query($conn, $sql_upd);        } else {            // Store in user_otp table            $user->store_otp($user_id, $otp, $created_at, $expired_at);        }        $json['success'] = "OTP successfully sent to mobile number";    } else {        $json['error'] = "Mobile number is not registered";    }    echo json_encode($json);}if (isset($_POST['action']) && $_POST['action'] == 'verify_user_otp') {    $json = array();    $user_id = $_SESSION['user_id'];    $otp = trim(strip_tags(mysqli_real_escape_string($conn, $_POST['otp'])));    // check that if the OTP is valid exists in DB    $sql = "SELECT * FROM ct_user_otp WHERE user_id='{$user_id}'";    $result = mysqli_query($conn, $sql);    date_default_timezone_set('Asia/Kolkata');    $current_time = date('Y-m-d H:i:s', time());    if (mysqli_num_rows($result) > 0) {        $user_otp_data = mysqli_fetch_object($result);        if (($user_otp_data->otp === $otp) && ($current_time < $user_otp_data->expired_at)) {            $user_data = $user->get_user_data($user_id);            if (mysqli_num_rows($user_data) > 0) {                $row_user_data = mysqli_fetch_object($user_data);                $_SESSION['ct_login_user_id'] = $user_id;                $_SESSION['ct_user_email'] = $row_user_data->user_email;                $json['success'] = "Login successfully";            }        } else {            $json['error'] = "Invalid OTP";        }    } else {        $json['error'] = "Mobile number is not registered";    }    echo json_encode($json);}if (isset($_POST['action']) && $_POST['action'] == 'resend_otp') {    $json = array();    $user_id = $_SESSION['user_id'];    // check that if the OTP is valid exists in DB    $sql = "SELECT * FROM ct_users WHERE id='{$user_id}'";    $result = mysqli_query($conn, $sql);    if (mysqli_num_rows($result) > 0) {        date_default_timezone_set('Asia/Kolkata');        $created_at = date('Y-m-d H:i:s', time());        $row_user = mysqli_fetch_object($result);        $user_id = $_SESSION['user_id'];        $expired_at = $user->getCurrentTime();                // max_attempts 2 + 1(time of mobile number verification) = 3 login attempts        $max_attempts = 2;                // check that if the OTP_count is exists in DB        $sql_otp_cnt = "SELECT * FROM ct_otp_count WHERE user_id='{$user_id}'";        $res_otp_cnt = mysqli_query($conn, $sql_otp_cnt);        if (mysqli_num_rows($res_otp_cnt) > 0) {                        // check that if the otp count attempts is valid & exists in DB            $row_otp_cnt = mysqli_fetch_object($res_otp_cnt);            if ($row_otp_cnt->count >= $max_attempts && strtotime($created_at) < strtotime($row_otp_cnt->expired_at)) {                $json['error'] = 'OTP can be sent maximum upto 3 times';            } else {                // check current time smaller than expiry time                if ($created_at < $row_otp_cnt->expired_at) {                    // UPDATE only the count                    $otp_cnt = $row_otp_cnt->count + 1;                    mysqli_query($conn, "UPDATE ct_otp_count SET count='{$otp_cnt}' WHERE user_id='{$user_id}'");                } else {                    // UPDATE count & expiry time                    $otp_cnt = 1;                    mysqli_query($conn, "UPDATE ct_otp_count SET count='{$otp_cnt}', expired_at='{$expired_at}' WHERE user_id='{$user_id}'");                }            }        } else {            $otp_count = 1;            // INSERT into OTP count table            mysqli_query($conn, "INSERT INTO ct_otp_count (user_id, count, expired_at) VALUES ('{$user_id}', '{$otp_count}', '{$expired_at}')");        }                // If not errors        if (empty($json['error'])) {            // Generate OTP            $otp = $user->generate_otp(4);            $message = "Yup-Serve : Your OTP verification code is {$otp}";            // SMS API            $sms_api = new Sinfini_sms();            $mobile = $row_user->phone;            // send SMS using API            $sms_api->send($mobile, $message);            // created_at            date_default_timezone_set('Asia/Kolkata');            $created_at = date('Y-m-d H:i:s', time());            // get 15 MInutes time interval            $expired_at = $user->getCurrentTime();            // check that user already exists            $otp_sql = "SELECT * FROM ct_user_otp WHERE user_id='{$user_id}'";            $result_otp = mysqli_query($conn, $otp_sql);            // check that row exists in OTP table            if (mysqli_num_rows($result_otp) > 0) {                // UPDATE OTP table                $sql_upd = "UPDATE ct_user_otp SET otp='{$otp}', created_at='{$created_at}', expired_at='{$expired_at}' WHERE user_id='{$user_id}'";                mysqli_query($conn, $sql_upd);            } else {                // Store in user_otp table                $user->store_otp($user_id, $otp, $created_at, $expiry_time);            }            // display success message to user            $json['success'] = "OTP sent successfully";        }    } else {        $json['error'] = "Mobile number is not registered";    }    echo json_encode($json);}if (isset($_POST['action']) && $_POST['action'] == 'click_notification') {    $json = array();    $id = $_POST['id'];    $sql = "UPDATE ct_user_notification SET is_read='1' WHERE id='{$id}'";    mysqli_query($conn, $sql);    if (mysqli_affected_rows($conn)) {        $json['success']['message'] = 'Message read successfully';    } else {        $json['error']['message'] = 'Message not set to read successfully';    }    echo json_encode($json);}